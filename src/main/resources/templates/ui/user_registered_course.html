<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LangTrip | ê°•ì˜ì‹¤</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Bootstrap JS ë¡œë“œ -->
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" th:href="@{/css/user_registered_course.css}">
<style>
.donation-modal-container { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
.donation-modal-content { position: relative; background-color: #fefefe; width: 90%; max-width: 520px; height: 90%; max-height: 750px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19); border-radius: 10px; overflow: hidden; animation: animatetop 0.4s; }
@keyframes animatetop { from {transform: translateY(-100px); opacity: 0} to {transform: translateY(0); opacity: 1} }
</style>
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

</head>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<body>
    <div id="donationModalContainer" class="donation-modal-container">
        <div class="donation-modal-content">
            <iframe id="donationFrame" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    </div>
	<!-- ëª¨ë°”ì¼ ë©”ë‰´ í† ê¸€ -->
	<button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
		â˜°</button>

	<!-- ëª¨ë°”ì¼ ì˜¤ë²„ë ˆì´ -->
	<div class="mobile-overlay" onclick="toggleMobileMenu()"></div>

	<div class="container-fluid">
		<div class="row">


			<div class="left-panel" id="leftPanel">
				<div class="side-panel">
					<h5>ğŸ¯ ê°•ì˜ í†µê³„</h5>
					<p class="mb-3">ì´ë²ˆ ê°•ì˜ì˜ í†µê³„</p>
					<div
						style="background: #ddf4ff; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #84d8ff;">
						<div style="font-size: 14px; color: #1cb0f6; margin-bottom: 5px;">ìˆ˜ê°•ìƒ
							ìˆ˜</div>
						<div style="font-size: 24px; font-weight: 700; color: #1cb0f6;">
							<span>ğŸ‘¥<span th:text="${courseData.enrollCount}"></span></span>
						</div>
					</div>
					<!-- 					<button class="btn btn-outline-primary btn-sm w-100 mb-2">ğŸ“ˆ -->
					<!-- 						ì§„ë„ ë³´ê¸°</button> -->
				</div>

				<div class="side-panel">
					<h5>ğŸ“‹ í•™ìŠµ ê³µì§€</h5>
					<p class="mb-3">ê°•ì‚¬ë‹˜ì˜ ê³µì§€ ì…ë‹ˆë‹¤.</p>


					<button class="btn btn-outline-primary btn-sm w-100 mb-2"
						data-bs-toggle="modal" data-bs-target="#noticeViewModal"
						onclick="loadNotice()">ğŸ“– ê³µì§€ ë³´ê¸°</button>
				</div>

				<div class="side-panel">
					<h5>ğŸ’¡ í•™ìŠµ ë„ì›€ë§</h5>
					<p class="mb-3">íš¨ê³¼ì ì¸ í•™ìŠµ ë°©ë²•ì„ ì•Œì•„ë³´ì„¸ìš”.</p>
					<div
						style="background: #f0f9ff; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #bae6fd;">
						<div style="font-size: 12px; color: #0369a1; line-height: 1.4;">
							ğŸ’¡ <strong>TIP:</strong> ë™ì˜ìƒì„ ì‹œì²­í•œ í›„ ë°”ë¡œ í€´ì¦ˆë¥¼ í’€ì–´ë³´ì„¸ìš”!
						</div>
					</div>
					
					<button class="btn btn-outline-primary btn-sm w-100"
						data-bs-toggle="modal" data-bs-target="#learningViewModal" 
						onclick="loadLearning()">ğŸ’¡
						í•™ìŠµ ê°€ì´ë“œ ë³´ê¸°</button>
				</div>
			</div>
			<div class="main-content">
				<input type="hidden" id="userSeq" th:value="${userSeq}" /> <input
					type="hidden" id="courseSeq" th:value="${courseData.courseSeq}" />
				<div class="content-wrapper">
					<div class="lecture-section">
						<div class="lecture-header">
							<a href="/mypage?tab=user_course" class="btn btn-success">â† ë’¤ë¡œê°€ê¸°</a>
						</div>
						<div id="courseDataSector"></div>
						<div class="course-info">
							<h2 th:text="${courseData.courseTitle}"></h2>
							<div class="course-meta">
								<span th:text="|ê°•ì˜ë²ˆí˜¸: ${courseData.courseSeq}|"> </span> <span
									th:text="|ë“±ë¡ì¼: ${#dates.format(courseData.uploadDate, 'yyyyë…„ Mì›” dì¼ HH:mm')}|"></span>
								<span th:text="|ì»¨í…ì¸  ìˆ˜ : ${courseData.contentCount}|"></span>
							</div>
						</div>
						<div class="video-section">
							<div th:if="${combinedList.isEmpty()}" class="lecture-empty">
								<!-- 							<div th:if="${videoList.isEmpty() && quizList.isEmpty()}" -->
								ë“±ë¡ëœ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.
								<div style="margin-top: 20px; font-size: 14px; color: #999;">
									ìƒˆë¡œìš´ ê°•ì˜ë¥¼ ë“±ë¡í•´ë³´ì„¸ìš”!</div>
							</div>

							<div th:if="${combinedList != null and !combinedList.isEmpty()}">
								<h3>ë“±ë¡ëœ ê°•ì˜ ì˜ìƒ ëª©ë¡</h3>
								<div class="video-tree">
									<div th:each="item, stat : ${combinedList}" class="video-node">
										<button type="button" class="circle-button"
											th:data-videoseq="${item.type == 'video' ? item.videoSeq : ''}"
											th:data-quizListseq="${item.type == 'quiz' ? item.quizListSeq : ''}"
											th:data-courseseq="${item.courseSeq}"
											onclick="goToVideoOrQuiz(this)">
											<i class="fa-solid"
												th:classappend="${item.type == 'video' ? 'fa-star' : 'fa-book'}"></i>
										</button>
										<!-- 						                th:data-quizListseq="${item.type == 'quiz' ? item.quizListSeq : ''}" -->
									</div>
								</div>
							</div>





						</div>

						<!-- ìš°ì¸¡ ì„¤ëª… íŒ¨ë„ -->
						<div class="right-panel">
							<div class="side-panel">
								<h5>ğŸ“– ê°•ì˜ ì„¤ëª…</h5>
								<a th:text="${courseData.introduction}"></a>

							</div>

							<!-- 						<div class="side-panel"> -->
							<!-- 							<h5>ğŸ“Š ê°•ì˜ ìˆ˜ê°•í•˜ê¸°</h5> -->
							<!-- 							<p class="mb-3">ê°•ì˜ë¥¼ ìˆ˜ê°•í•´ë³´ì„¸ìš”.</p> -->
							<!-- 							<a class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="goToDonate('${courseData.courseSeq}')"> -->
							<!-- 							 ìˆ˜ê°•í•˜ê¸°</a>							 -->
							<!-- 						</div> -->
							<div class="side-panel">
								<h5>ğŸ’– í›„ì›í•˜ê¸°</h5>
								<p class="mb-3">ê°•ì‚¬ë‹˜ê»˜ í›„ì›í•´ë³´ì„¸ìš”.</p>
								<a class="btn btn-outline-primary btn-sm w-100 mb-2"
									th:onclick="goToDonate([[${courseData.courseSeq}]])"> í›„ì›í•˜ê¸°</a>
							</div>

							<!-- 						<div class="side-panel"> -->
							<!-- 							<h5>âš™ï¸ ê°•ì˜ ì„¤ì •</h5> -->
							<!-- 							<p class="mb-3">ê°•ì˜ ì„¤ì •ì„ ë³€ê²½í•˜ì„¸ìš”.</p> -->
							<!-- 							<button class="btn btn-outline-primary btn-sm mb-2">âœï¸ ê°•ì˜ ìˆ˜ì •</button> -->
							<!-- 							<button class="btn btn-outline-secondary btn-sm">ğŸ—‘ï¸ ê°•ì˜ ì‚­ì œ</button> -->
							<!-- 						</div> -->
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- ì±—ë´‡ ëª¨ë‹¬ -->
		<div class="chatbot-modal" id="chatbotModal">
			<div class="chatbot-container">
				<div class="chatbot-header">
					<h4>ğŸ¤– í•™ìŠµ ë„ìš°ë¯¸</h4>
					<button class="chatbot-close" onclick="toggleChatbot()">Ã—</button>
				</div>
				<div class="chatbot-messages" id="chatbotMessages">
					<div class="message bot">ì•ˆë…•í•˜ì„¸ìš”! í•™ìŠµ ë„ìš°ë¯¸ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
				</div>
				<div class="chatbot-input">
					<div class="chatbot-input-group">
						<input type="text" id="chatbotInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
							onkeypress="handleChatbotEnter(event)">
						<button class="chatbot-send" onclick="sendChatbotMessage()">ì „ì†¡</button>
					</div>
				</div>
			</div>
		</div>
	</div>


	<!-- í”„ë¡œí•„ ìºë¦­í„° (ì±—ë´‡ ë²„íŠ¼) -->
	<div class="profile-icon" onclick="toggleChatbot()">
		<img src="/images/mascot2.png" alt="ë§ˆìŠ¤ì½”íŠ¸"
			onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjUiIGZpbGw9IiM0YTkwZTIiLz4KPHN2ZyB3aWR0aD0iMzAiIGhlaWdodD0iMzAiIHZpZXdCb3g9IjAgMCAzMCAzMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTUiIGN5PSIxNSIgcj0iMTUiIGZpbGw9IndoaXRlIi8+CjxjaXJjbGUgY3g9IjEwIiBjeT0iMTIiIHI9IjIiIGZpbGw9IiMzMzMiLz4KPGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMiIgZmlsbD0iIzMzMyIvPgo8cGF0aCBkPSJNMTAgMjBRMTUgMjUgMjAgMjAiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSIyIiBmaWxsPSJub25lIi8+Cjwvc3ZnPgo8L3N2Zz4K'">
	</div>


	<script>
	function goToVideoOrQuiz(button){
		const videoSeq = button.dataset.videoseq;  // videoSeq ê°’
	    const quizSeq = button.dataset.quizlistseq;  // quizSeq ê°’
	    const courseSeq = button.dataset.courseseq;

	    console.log("videoSeq : " + videoSeq);
	    console.log("quizSeq : " + quizSeq);

	    if (quizSeq) {
	        // í€´ì¦ˆ ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™
	        console.log("í€´ì¦ˆ ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™");
	        location.href = "/quiz/playQuiz/" + quizSeq+"?courseSeq=" + courseSeq;
	    } else if (videoSeq) {
	        // ì˜ìƒ í˜ì´ì§€ë¡œ ì´ë™
	        console.log("ì˜ìƒ í˜ì´ì§€ë¡œ ì´ë™");
	        location.href = "/video/watch?videoSeq=" + videoSeq + "&courseSeq=" + courseSeq;
	    }
	}
	function goToVideo(button) {
			  const videoSeq = button.dataset.videoseq;
			  const courseSeq = button.dataset.courseseq;
			  const from = "user1"; // ì¼ë°˜ ìœ ì €
			  location.href = "/video/watch?videoSeq=" + videoSeq + "&courseSeq=" + courseSeq + "&from=" + from;
			}
		
		
		function goToDonate(courseSeq){
			const modalContainer = document.getElementById('donationModalContainer');
			const iframe = document.getElementById('donationFrame');
			iframe.src = `/user/donation?lectureNo=${courseSeq}`;
			modalContainer.style.display = 'flex';
		}

		window.addEventListener('message', function(event) {
		    if (event.data === 'closeDonationModal') {
		        document.getElementById('donationModalContainer').style.display = 'none';
		    }
		});
		//í€´ì¦ˆ
		const startButtons = document.querySelectorAll(".start-quiz-button");
		  startButtons.forEach(btn => {
		    btn.addEventListener("click", function () {
		      const quizListSeq = this.dataset.quizId;
		      const quizCourseSeq = this.dataset.courseId;
		      startQuiz(quizListSeq, quizCourseSeq);
		    });
		  });
		//í€´ì¦ˆ ì‹œì‘ì‹œ í•™ìŠµ í™”ë©´ìœ¼ë¡œ ì´ë™
		  function startQuiz(quizListSeq, courseSeq) {
		    location.href = "/quiz/playQuiz/" + quizListSeq+"?courseSeq=" + courseSeq;
		  }
		
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function toggleChatbot() {
            const modal = document.getElementById('chatbotModal');
            modal.classList.toggle('active');
        }

        function sendChatbotMessage() {
            const input = document.getElementById('chatbotInput');
            const messages = document.getElementById('chatbotMessages');
            const message = input.value.trim();
            
            if (message) {
                // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
                const userMessage = document.createElement('div');
                userMessage.className = 'message user';
                userMessage.textContent = message;
                messages.appendChild(userMessage);
                
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                input.value = '';
                
                
                axios.post("/api/chat", message, {
                	headers:{
                		"Content-Type": "text/plain"
                	}
                }).
                then(res=>{
  					const botResponse = document.createElement('div');
  					botResponse.className = 'message bot';
  					botResponse.textContent = res.data;
  					messages.scrollTop = messages.scrollHeight;
  					messages.appendChild(botResponse);
  					messages.scrollTop = messages.scrollHeight;
                }).
                catch(err=>{
                	 const errorMsg = document.createElement('div');
                     errorMsg.className = 'message bot';
                     errorMsg.textContent = "ì˜¤ë¥˜ ë°œìƒ: " + err;
                     messages.appendChild(errorMsg);
                });
            }
        }
        function handleChatbotEnter(event) {
            if (event.key === 'Enter') {
                sendChatbotMessage();
            }
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('chatbotModal').addEventListener('click', function(e) {
            if (e.target === this) {
                toggleChatbot();
            }
        });

        // ì‚¬ì´ë“œë°” ë§í¬ í™œì„±í™”
        document.querySelectorAll('.sidebar a').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
                this.classList.add('active');
                
                // ëª¨ë°”ì¼ì—ì„œ ë©”ë‰´ í´ë¦­ ì‹œ ì‚¬ì´ë“œë°” ë‹«ê¸°
                if (window.innerWidth <= 768) {
                    toggleMobileMenu();
                }
            });
        });

        // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ì‚¬ì´ë“œë°” ìƒíƒœ ì´ˆê¸°í™”
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                document.getElementById('sidebar').classList.remove('active');
                document.querySelector('.mobile-overlay').classList.remove('active');
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì• ë‹ˆë©”ì´ì…˜
        document.addEventListener('DOMContentLoaded', function() {
            const panels = document.querySelectorAll('.side-panel');
            panels.forEach((panel, index) => {
                panel.style.animationDelay = `${index * 0.1}s`;
            });
        });
        
        
        
        
        
    </script>
	<div id="noticeViewModal" class="modal fade" tabindex="-1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content p-4">
				<h5 class="mb-3">ğŸ“– ë“±ë¡ëœ ê³µì§€</h5>
				<div id="noticeDisplay" style="white-space: pre-line;"></div>
				<div class="text-end mt-3">
					<!-- 					<button class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button> -->
				</div>
			</div>
		</div>
	</div>
	
	<div id="learningViewModal" class="modal fade" tabindex="-1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content p-4">
				<h5 class="mb-3">ğŸ’¡ ë“±ë¡ëœ í•™ìŠµê°€ì´ë“œ</h5>
				<div id="learningDisplay" style="white-space: pre-line;"></div>
				<div class="text-end mt-3">
					<!-- 					<button class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button> -->
				</div>
			</div>
		</div>
	</div>
	
	<script>
    document.addEventListener("DOMContentLoaded", () => {
    	  const userSeq = document.getElementById("userSeq").value;
    	  const buttons = document.querySelectorAll(".circle-button");

    	  buttons.forEach(button => {
    	    const videoSeq = button.dataset.videoseq;
    	    const courseSeq = button.dataset.courseseq;
			
    	    axios.get("/course/stat/get", {
    	      params: { userSeq, videoSeq, courseSeq }
    	    }).then(res => {
    	      const progress = res.data.courseRate || 0;
//     	      const icon = button.querySelector("i");

//     	      if (!icon) {
//     	        console.warn("i íƒœê·¸ ì—†ìŒ - í•´ë‹¹ ë²„íŠ¼:", button);
//     	        return;
//     	      }

    	      if (progress >= 99.9) {
		        button.classList.add("completed");
		        console.log("button ìƒíƒœ í™•ì¸", button.classList);
		      } else {
		        button.classList.remove("completed");
		      }
    	    }).catch(err => {
    	      console.error("ì§„í–‰ë¥  ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", err);
    	    });
    	  });
    	  
    	  //í€´ì¦ˆ ë²„íŠ¼ ì™„ë£Œ ì²˜ë¦¬
    	  const quizButtons = document.querySelectorAll(".circle-button");

    	  quizButtons.forEach(button => {
    	      const quizListSeq = button.dataset.quizlistseq; 
    	      const courseSeq = button.dataset.courseseq;

    	      if (!quizListSeq) return; // í€´ì¦ˆê°€ ì•„ë‹Œ ë²„íŠ¼ì€ ë¬´ì‹œ

    	      axios.get("/quiz/status", {
    	          params: { userSeq, quizListSeq }
    	      }).then(res => {
    	          const quizStatus = res.data.status;
    	          if (quizStatus === "complete") {
    	              button.classList.add("completed");
    	          }
    	      }).catch(err => {
    	          console.error("í€´ì¦ˆ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨", err);
    	      });
    	  });
    	  
    	});
    
    
    function loadNotice() {
        const courseSeq = document.getElementById("courseSeq").value;

        // courseSeqë¥¼ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì„œë²„ì— ì „ë‹¬
        axios.get('/api/notice/latest', { params: { courseSeq: courseSeq } })
            .then(response => {
            	
                const noticeContent = response.data.content; // ì„œë²„ì—ì„œ ë°›ì€ ê³µì§€ ë‚´ìš©
                document.getElementById('noticeDisplay').textContent = noticeContent; // ëª¨ë‹¬ì— í‘œì‹œ

//                 // Bootstrap 5 ëª¨ë‹¬ ìˆ˜ë™ìœ¼ë¡œ ì—´ê¸°
                const noticeViewModal = new bootstrap.Modal(document.getElementById('noticeViewModal'));
                noticeViewModal.show();  // ëª¨ë‹¬ ì—´ê¸°
            })
            .catch(error => {
                console.error(error);
                alert("ê³µì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
            });
    }
    function loadLearning() {
   	 const courseSeq = document.getElementById("courseSeq").value;

       // courseSeqë¥¼ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì„œë²„ì— ì „ë‹¬
       axios.get('/api/notice/latestLearning', { params: { courseSeq: courseSeq } })
           .then(response => {
               const learningContent = response.data.content; // ì„œë²„ì—ì„œ ë°›ì€ ê³µì§€ ë‚´ìš©
               document.getElementById('learningDisplay').textContent = learningContent; // ëª¨ë‹¬ì— í‘œì‹œ
               const learningViewModal = new bootstrap.Modal(document.getElementById('learningViewModal'));
               learningViewModal.show();  // ëª¨ë‹¬ ì—´ê¸°
           
           })
           .catch(error => {
               console.error(error);
               alert("ê³µì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
           });
   }
    

</script>

</body>
</html>