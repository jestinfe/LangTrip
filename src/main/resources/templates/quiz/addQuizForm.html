<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>LangTrip | í€´ì¦ˆ ë“±ë¡</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link rel="stylesheet" th:href="@{/css/addQuiz.css}"> 
</head>
<body>
<button type="button" id="backButton" class="back-button"><span aria-hidden="true">&larr;</span></button>

<div class="logo-box text-center mb-4">
  <img th:src="@{/images/quiz/mascot_logo.png}" alt="LangTrip Logo">
</div>

<!-- í€´ì¦ˆ ë©”íƒ€ ì •ë³´ ì…ë ¥ -->
<div class="container mb-4">
  <div class="form-card">
    <label>í€´ì¦ˆ ì œëª©</label>
    <input type="text" id="quizTitle" class="form-control" placeholder="í€´ì¦ˆ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.">
	<input type="hidden" id="courseSeq" th:value="${courseSeq}">
    
   <!--  <label class="mt-3">ì–¸ì–´ ë¶„ë¥˜</label>
    <select id="langCategory" class="form-select">
    <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
      <option value="ì˜ì–´">ì˜ì–´</option>
      <option value="ì¼ë³¸ì–´">ì¼ë³¸ì–´</option>
      <option value="ì¤‘êµ­ì–´">ì¤‘êµ­ì–´</option>
    </select> -->
    
     <div class="type-examples mt-4">
          <div class="example-box mb-2">
            <strong class="example-label">í€´ì¦ˆ ì˜ˆì‹œ</strong>
            <span class="example-label">ğŸ’¡ ì´ë¯¸ì§€ í€´ì¦ˆëŠ” ìµœëŒ€ 3ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤ !</span>
            <img src="/images/quiz/text-quiz-ex.png" class="img-thumbnail">
            <img src="/images/quiz/image-quiz-ex.png" class="img-thumbnail">
          </div>
      </div>
  </div>
</div>


<!-- í€´ì¦ˆ ì…ë ¥ ì˜ì—­ -->
<div id="quizContainer" class="container"></div>

<div class="button-wrapper">
  <button type="button" id="submitQuizBtn" class="btn btn-primary submit-btn w-100">í€´ì¦ˆ ë“±ë¡ ì™„ë£Œ</button>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script>
$(function () {
  const totalQuiz = 5; //ì´ í€´ì¦ˆ ê°œìˆ˜
  const quizContainer = $("#quizContainer");

  for (let i = 0; i < totalQuiz; i++) {
    const quizHTML = `
      <div class="slide" data-index="${i}">
        <div class="form-card">
          <div class="form-title">${i + 1}ë²ˆ í€´ì¦ˆ</div>
          <label>ìœ í˜• ì„ íƒ</label>
          <select name="quiz[${i}].type" class="form-select">
            <option value="text-quiz">í…ìŠ¤íŠ¸ í€´ì¦ˆ</option>
            <option value="img-quiz">ì´ë¯¸ì§€ í€´ì¦ˆ</option>
          </select>

          <label>ë¬¸ì œ</label>
          <textarea name="quiz[${i}].question" rows="2" class="form-control"></textarea>

          <label>ë³´ê¸°</label>
          <div class="options-wrapper"></div>
        </div>
      </div>
    `;
    quizContainer.append(quizHTML);
  }

  // ìœ í˜• ì„ íƒ ì‹œ í•´ë‹¹ í€´ì¦ˆ indexì— ë§ëŠ” ë³´ê¸° í…œí”Œë¦¿ ì‚½ì…
  $(document).on('change', 'select[name$=".type"]', function () {
    const $slide = $(this).closest('.slide');
    const idx = $slide.data('index');
    const type = $(this).val();
    const $wrap = $slide.find('.options-wrapper');
    const template = type === 'text-quiz' ? getTextOptionsTemplate(idx) : getImgOptionsTemplate(idx);
    $wrap.html(template);
  });

  // í…ìŠ¤íŠ¸ í€´ì¦ˆ ë³´ê¸° í…œí”Œë¦¿ ìƒì„±
  function getTextOptionsTemplate(idx) {
    return `
      <div class="text-options">
        ${[0, 1, 2].map(i => `
          <div class="option-row">
            <input type="text" name="quiz[${idx}].options[${i}].content" class="form-control mb-2" placeholder="ë³´ê¸° ${i+1}">
            <button type="button" class="btn btn-danger btn-sm remove-option">X</button>
          </div>
        `).join('')}
        <button type="button" class="btn btn-secondary btn-sm add-option" data-quiz-idx="${idx}">+ ë³´ê¸° ì¶”ê°€</button>
      </div>
      <label>ì •ë‹µ</label>
      <select name="quiz[${idx}].correctOption" class="form-select correct-option">
        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
        <option value="1">ë³´ê¸° 1</option>
        <option value="2">ë³´ê¸° 2</option>
        <option value="3">ë³´ê¸° 3</option>
      </select>
    `;
  }

  // ì´ë¯¸ì§€ í€´ì¦ˆ ë³´ê¸° í…œí”Œë¦¿ ìƒì„± (3ì§€ì„ ë‹¤ ê³ ì •)
  function getImgOptionsTemplate(idx) {
    return [0, 1, 2].map(i => `
      <div class="option-row">
        <div class="img-preview-box">
          <img class="img-preview">
        </div>
        <div class="option-fields">
          <input type="text" name="quiz[${idx}].options[${i}].content" class="form-control mb-2" placeholder="ë³´ê¸° ${i+1}">
          <input type="file" name="quiz[${idx}].options[${i}].image" class="form-control option-image" accept="image/*">
        </div>
      </div>
    `).join('') + `
      <label>ì •ë‹µ</label>
      <select name="quiz[${idx}].correctOption" class="form-select">
        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
        <option value="1">ë³´ê¸° 1</option>
        <option value="2">ë³´ê¸° 2</option>
        <option value="3">ë³´ê¸° 3</option>
      </select>
    `;
  }

  // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ë™ì‘
  $(document).on("change", ".option-image", function () {
    const file = this.files[0];
    const $preview = $(this).closest('.option-row').find(".img-preview");
    if (file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        $preview.attr("src", e.target.result).show();
      };
      reader.readAsDataURL(file);
    } else {
      $preview.attr("src", "").hide();
    }
  });

  // ì´ˆê¸°ê°’ ì„¤ì •
  $(".slide").each(function () {
    const idx = $(this).data("index");
    $(this).find(`select[name="quiz[${idx}].type"]`).val("text-quiz").trigger("change");
  });

  // ë³´ê¸° ì¶”ê°€ ë²„íŠ¼
  $(document).on("click", ".add-option", function () {
    const $slide = $(this).closest(".slide");
    const idx = $slide.data("index");
    const $wrapper = $slide.find(".text-options");
    const $options = $wrapper.find(".option-row");
    const count = $options.length;

    if (count >= 5) {
      alert("ë³´ê¸°ëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      return;
    }

    const newOption = `
      <div class="option-row">
        <input type="text" name="quiz[${idx}].options[${count}].content" class="form-control mb-2" placeholder="ë³´ê¸° ${count+1}">
        <button type="button" class="btn btn-danger btn-sm remove-option">X</button>
      </div>
    `;

    $(this).before(newOption);
    updateCorrectOptionSelect($slide);
  });

  // ë³´ê¸° ì‚­ì œ ë²„íŠ¼
  $(document).on("click", ".remove-option", function () {
    const $slide = $(this).closest(".slide");
    const $wrapper = $slide.find(".text-options");
    const $rows = $wrapper.find(".option-row");

    if ($rows.length <= 3) {
      alert("ë³´ê¸°ëŠ” ìµœì†Œ 3ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
      return;
    }

    $(this).closest(".option-row").remove();
    updateOptionPlaceholders($slide);
    updateCorrectOptionSelect($slide);
  });

  // ë³´ê¸° placeholder ë° name ì¬ì •ë ¬
  function updateOptionPlaceholders($slide) {
    const idx = $slide.data("index");
    $slide.find(".option-row").each(function (i) {
      $(this).find("input[type='text']")
        .attr("placeholder", `ë³´ê¸° ${i+1}`)
        .attr("name", `quiz[${idx}].options[${i}].content`);
    });
  }

  // ì •ë‹µ ì½¤ë³´ë°•ìŠ¤ ì¬êµ¬ì„±
  function updateCorrectOptionSelect($slide) {
    const idx = $slide.data("index");
    const $select = $slide.find("select.correct-option");
    const count = $slide.find(".option-row").length;

    $select.empty();
    $select.append('<option value="">ì„ íƒí•˜ì„¸ìš”</option>');
    for (let i = 1; i <= count; i++) {
      $select.append(`<option value="${i}">ë³´ê¸° ${i}</option>`);
    }
  }

  // ë“±ë¡ ë²„íŠ¼ í´ë¦­ ì‹œ FormData ì „ì†¡
  $("#submitQuizBtn").click(function () {
	
	// ì—¬ëŸ¬ ë¬¸ì œë“¤ì„ ì €ì¥í•  ë°°ì—´
	const quizList = [];
    const imageFiles = [];

 	// ì´ë¯¸ì§€ í€´ì¦ˆ ê°œìˆ˜ ì œí•œ ê²€ì‚¬ -> 3ê°œê¹Œì§€ë§Œ ê°€ëŠ¥
	let imgQuizCount = 0;
	$(".slide").each(function () {
	  const type = $(this).find("select[name$='.type']").val();
	  if (type === "img-quiz") {
	    imgQuizCount++;
	  }
	});
	if (imgQuizCount > 3) {
	  alert("ì´ë¯¸ì§€ í€´ì¦ˆëŠ” 3ê°œê¹Œì§€ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
	  return;
	}
	
	// ì´ë¯¸ì§€ íŒŒì¼ ìˆ˜ ê²€ì‚¬
	if (imageFiles.length > 9) {
	  alert("ì´ë¯¸ì§€ íŒŒì¼ì€ ìµœëŒ€ 9ê°œê¹Œì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
	  return;
	}
    
	// ë¬¸ì œ ì œëª© null ë°©ì§€
	const title = $("#quizTitle").val().trim();
	if (title === "") {
	  alert("í€´ì¦ˆ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
	  $("#quizTitle").focus();
	  return;
	}
    
 	// í•„ìˆ˜ ì…ë ¥ê°’ ê°„ë‹¨ ê²€ì¦
    let isValid = true;

    $(".slide").each(function (i) {
      const question = $(this).find("textarea").val().trim();
      if (question === "") {
        alert(`${i + 1}ë²ˆ ë¬¸ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
        $(this).find("textarea").focus();
        isValid = false;
        return false;
      }

      const options = $(this).find(".option-row input[type='text']");
      for (let j = 0; j < options.length; j++) {
        if ($(options[j]).val().trim() === "") {
          alert(`${i + 1}ë²ˆ ë¬¸ì œì˜ ë³´ê¸° ${j + 1}ë²ˆ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
          $(options[j]).focus();
          isValid = false;
          return false;
        }
      }

      const correct = $(this).find("select[name$='.correctOption']").val();
      if (!correct) {
        alert(`${i + 1}ë²ˆ ë¬¸ì œì˜ ì •ë‹µì„ ì„ íƒí•´ì£¼ì„¸ìš”.`);
        $(this).find("select[name$='.correctOption']").focus();
        isValid = false;
        return false;
      }
    });

    if (!isValid) return; // ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì „ì†¡ ì¤‘ë‹¨
    
    // ê° í€´ì¦ˆ ìŠ¬ë¼ì´ë“œ(ë¬¸ì œ ë‹¨ìœ„)ë¥¼ ìˆœíšŒí•˜ë©´ì„œ ë°ì´í„° ìˆ˜ì§‘
    $(".slide").each(function (quizIdx) {
      const $slide = $(this);
      const type = $slide.find(`select[name="quiz[${quizIdx}].type"]`).val();//í…ìŠ¤íŠ¸orì´ë¯¸ì§€ í€´ì¦ˆ ìœ í˜•
      const question = $slide.find(`textarea[name="quiz[${quizIdx}].question"]`).val();//ë¬¸ì œ 
      const correctOption = $slide.find(`select[name="quiz[${quizIdx}].correctOption"]`).val();//ì •ë‹µ
      const options = [];

      $slide.find(".option-row").each(function () {
        const content = $(this).find("input[type='text']").val();//ë³´ê¸° ë‚´ìš©
        const fileInput = $(this).find("input[type='file']");//ì´ë¯¸ì§€
        let fileIndex = null;//ì´ë¯¸ì§€ íŒŒì¼ ìˆœì„œ

        if (fileInput && fileInput.length && fileInput[0].files.length > 0) {
          fileIndex = imageFiles.length;
          imageFiles.push(fileInput[0].files[0]);
        }

        options.push({ content, fileIndex });
      });

      // ë¬¸ì œ í•˜ë‚˜ë¥¼ quizListì— ì¶”ê°€
      quizList.push({
        type,
        question,
        correctOption: parseInt(correctOption), // ì •ë‹µì€ ì •ìˆ˜ë¡œ ë³€í™˜ (1,2,3)
        options
      });
    });
    
 	// ì„œë²„ë¡œ ë³´ë‚¼ formData êµ¬ì„± (íŒŒì¼ + JSON ë°ì´í„°)
    const formData = new FormData();
 	
    // ì „ì²´ í€´ì¦ˆ ë¬¶ìŒ ì •ë³´ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì¶”ê°€
    formData.append("quizJson", JSON.stringify({
      title: $("#quizTitle").val(),
      langCategory: $("#langCategory").val(),
      courseSeq: $("#courseSeq").val(),
      quiz: quizList
    }));
    // ì´ë¯¸ì§€ íŒŒì¼ë“¤ formDataì— í•˜ë‚˜ì”© ì¶”ê°€
    imageFiles.forEach(file => formData.append("imageFiles", file));

    // axiosë¡œ multipart/form-data ë°©ì‹ POST ìš”ì²­
    axios.post("/addQuizForm", formData, {
      headers: { "Content-Type": "multipart/form-data" }
    })
    .then(res => {
      if (res.data.startsWith("success")) {
	      alert("í€´ì¦ˆê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
	      const courseSeq = document.getElementById("courseSeq").value;
	      window.location.href = '/upload/upload_course?seq='+courseSeq;
      } 
    })
    .catch(err => {
      console.log("ì˜¤ë¥˜", err);
      alert("í€´ì¦ˆ ë“±ë¡ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤."); 
    });
  });

  // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  $("#backButton").click(function() {
	  const courseSeq = $("#courseSeq").val();
	  window.location.href = '/upload/upload_course?seq=' + courseSeq;
  });
});
</script>
</body>
</html>
