<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>LangTrip | í€´ì¦ˆ ìˆ˜ì •</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link rel="stylesheet" th:href="@{/css/modifyQuiz.css}">
</head>
<body>
<input type="hidden" id="quizListSeq" th:value="${qlDTO.quizListSeq}" />
<input type="hidden" id="quizCourseSeq" th:value="${qDTO.courseSeq}"/>
<button type="button" id="backButton" class="back-button"><span aria-hidden="true">&larr;</span></button>
<!-- /quiz/playQuiz/{quizListSeq}?courseSeq={courseSeq} -->
<div class="hover-box">
<button type="button" id="playButton" class="play-button">
	<span aria-hidden="true">ë¯¸ë¦¬ë³´ê¸°</span>
</button>
<!-- <div class="tooltip-text">ì‘ë‹µì´ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div> -->
<div class="tooltip-text">ì‘ë‹µ ì €ì¥ ë¶ˆê°€</div>
</div>
<div class="logo-box text-center mb-4">
  <img th:src="@{/images/quiz/mascot_logo.png}" alt="LangTrip Logo">
</div>

<!-- í€´ì¦ˆ ë©”íƒ€ ì •ë³´ ì…ë ¥ -->
<div class="container mb-4">
  <div class="form-card">
    <label>í€´ì¦ˆ ì œëª©</label>
    <input type="text" id="quizTitle" class="form-control"
           placeholder="í€´ì¦ˆ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."
           th:value="${qlDTO.title}" />

   <!--  <label class="mt-3">ì–¸ì–´ ë¶„ë¥˜</label>
    <select id="langCategory" class="form-select">
      <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
      <option value="ì˜ì–´" th:selected="${qlDTO.langCategory == 'ì˜ì–´'}">ì˜ì–´</option>
      <option value="ì¼ë³¸ì–´" th:selected="${qlDTO.langCategory == 'ì¼ë³¸ì–´'}">ì¼ë³¸ì–´</option>
      <option value="ì¤‘êµ­ì–´" th:selected="${qlDTO.langCategory == 'ì¤‘êµ­ì–´'}">ì¤‘êµ­ì–´</option>
    </select> -->
    
    <div class="type-examples mt-4">
          <div class="example-box mb-2">
            <strong class="example-label">í€´ì¦ˆ ì˜ˆì‹œ</strong>
            <span class="example-label">ğŸ’¡ ì´ë¯¸ì§€ í€´ì¦ˆëŠ” ìµœëŒ€ 3ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤ !</span>
            <img src="/images/quiz/text-quiz-ex.png" class="img-thumbnail">
            <img src="/images/quiz/image-quiz-ex.png" class="img-thumbnail">
          </div>
      </div>
  </div>
</div>

<!-- í€´ì¦ˆ ì…ë ¥ ì˜ì—­ -->
<div id="quizContainer" class="container"></div>

<div class="button-wrapper">
  <button type="button" id="submitQuizBtn" class="btn btn-primary submit-btn w-100">í€´ì¦ˆ ìˆ˜ì • ì™„ë£Œ</button>
  <button type="button" id="deleteQuizBtn" class="btn btn-danger submit-btn w-100">í€´ì¦ˆ ì‚­ì œ</button>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script th:inline="javascript">
const existingQuizList = /*[[${qlDTO.quiz}]]*/ [];

$(function () {
  const quizContainer = $("#quizContainer");

  // í€´ì¦ˆ HTML ë Œë”ë§
  existingQuizList.forEach((quiz, quizIdx) => {
    const isTextQuiz = quiz.type === "text-quiz";
    const quizHTML = `
      <div class="slide" data-index="${quizIdx}">
        <div class="form-card">
          <div class="form-title">${quizIdx + 1}ë²ˆ í€´ì¦ˆ</div>
          
          <label>ìœ í˜• ì„ íƒ</label>
          <select class="form-select quiz-type">
            <option value="text-quiz" ${isTextQuiz ? "selected" : ""}>í…ìŠ¤íŠ¸ í€´ì¦ˆ</option>
            <option value="img-quiz" ${!isTextQuiz ? "selected" : ""}>ì´ë¯¸ì§€ í€´ì¦ˆ</option>
          </select>

          <label>ë¬¸ì œ</label>
          <textarea class="form-control quiz-question" rows="2">${quiz.question}</textarea>

          <label>ë³´ê¸°</label>
          <div class="options-wrapper"></div>

          <label>ì •ë‹µ</label>
          <select class="form-select correct-option"></select>
        </div>
      </div>
    `;
    quizContainer.append(quizHTML);
  });

  // ë³´ê¸° ë Œë”ë§
  $(".slide").each(function () {
    const idx = $(this).data("index");
    const quiz = existingQuizList[idx];
    renderOptions(this, quiz.type, quiz.options, quiz.correctOption);
  });

  // ìœ í˜• ì„ íƒ í•¸ë“¤ëŸ¬
  $(document).on("change", ".quiz-type", function() {
    const type = $(this).val();
    renderOptions(this, type);
  });

  // ë³´ê¸° ë Œë”ë§ í•¨ìˆ˜
  function renderOptions(element, type, options = [], correctOption = null) {
    const $slide = $(element).closest('.slide');
    const idx = $slide.data("index");
    const $wrapper = $slide.find(".options-wrapper");
    const $select = $slide.find(".correct-option");

    $wrapper.empty();
    $select.empty().append('<option value="">ì„ íƒí•˜ì„¸ìš”</option>');

    const isTextQuiz = type === 'text-quiz';
    const optionCount = isTextQuiz ? (options.length > 0 ? options.length : 3) : 3;

    for (let i = 0; i < optionCount; i++) {
      const opt = options[i] || {};
      let optionHTML = '';

      if (isTextQuiz) {
        optionHTML = `
          <div class="option-row">
            <input type="text" class="form-control mb-2 option-content" value="${opt.content || ''}" placeholder="ë³´ê¸° ${i + 1}">
            <button type="button" class="btn btn-danger btn-sm remove-option">X</button>
          </div>
        `;
      } else { // ì´ë¯¸ì§€ í€´ì¦ˆ
        optionHTML = `
          <div class="option-row">
            <div class="img-preview-box">
              <img class="img-preview" src="${opt.imageAddr || ''}" style="display: ${opt.imageAddr ? 'block' : 'none'};">
            </div>
            <div class="option-fields">
              <input type="text" class="form-control mb-2 option-content" value="${opt.content || ''}" placeholder="ë³´ê¸° ${i + 1}">
              <input type="file" class="form-control mb-2 option-image" accept="image/*">
              <input type="hidden" class="option-image-name" value="${opt.imageName || ''}">
              <input type="hidden" class="option-image-addr" value="${opt.imageAddr || ''}">
            </div>
          </div>
        `;
      }
      $wrapper.append(optionHTML);
    }

    // ì •ë‹µ ì„ íƒ ì˜µì…˜
    for (let i = 1; i <= optionCount; i++) {
      $select.append(`<option value="${i}" ${correctOption == i ? "selected" : ""}>ë³´ê¸° ${i}</option>`);
    }

    // ë³´ê¸° ì¶”ê°€ ë²„íŠ¼
    if (isTextQuiz) {
      $wrapper.append(`<button type="button" class="btn btn-secondary btn-sm add-option mt-2" data-quiz-idx="${idx}">+ ë³´ê¸° ì¶”ê°€</button>`);
    }
  }

  // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ë™ì‘
  $(document).on("change", ".option-image", function () {
    const file = this.files[0];
    const $preview = $(this).closest('.option-row').find(".img-preview");
    if (file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        $preview.attr("src", e.target.result).show();
      };
      reader.readAsDataURL(file);
    } else {
      $preview.attr("src", "").hide();
    }
  });

  // ë³´ê¸° ì¶”ê°€
  $(document).on("click", ".add-option", function () {
    const $slide = $(this).closest(".slide");
    const idx = $slide.data("index");
    const $wrapper = $slide.find(".options-wrapper");
    const count = $wrapper.find(".option-row").length;

    if (count >= 5) {
      alert("ë³´ê¸°ëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      return;
    }

    const newOption = `
      <div class="option-row">
        <input type="text" class="form-control mb-2 option-content" placeholder="ë³´ê¸° ${count + 1}">
        <button type="button" class="btn btn-danger btn-sm remove-option">X</button>
      </div>
    `;
    $(this).before(newOption);
    updateCorrectOptionSelect($slide);
  });

  // ë³´ê¸° ì‚­ì œ
  $(document).on("click", ".remove-option", function () {
    const $slide = $(this).closest(".slide");
    const $rows = $slide.find(".option-row");

    if ($rows.length <= 3) {
      alert("ë³´ê¸°ëŠ” ìµœì†Œ 3ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
      return;
    }

    $(this).closest(".option-row").remove();
    updateOptionPlaceholders($slide);
    updateCorrectOptionSelect($slide);
  });

  function updateOptionPlaceholders($slide) {
    $slide.find(".option-row").each((i, row) => {
      $(row).find(".option-content")
        .attr("placeholder", `ë³´ê¸° ${i + 1}`);
    });
  }

  function updateCorrectOptionSelect($slide) {
    const $select = $slide.find(".correct-option");
    const $options = $slide.find(".option-row");
    $select.empty().append('<option value="">ì„ íƒí•˜ì„¸ìš”</option>');
    $options.each((i) => {
      $select.append(`<option value="${i + 1}">ë³´ê¸° ${i + 1}</option>`);
    });
  }

  // ì œì¶œ ë²„íŠ¼
  $("#submitQuizBtn").click(function () {
    const quizList = [];
    const imageFiles = [];
    
 	// ì´ë¯¸ì§€ í€´ì¦ˆ ê°œìˆ˜ ì œí•œ ê²€ì‚¬ -> 3ê°œê¹Œì§€ë§Œ ê°€ëŠ¥
	let imgQuizCount = 0;
	$(".slide").each(function () {
	  const type = $(this).find("select[name$='.type']").val();
	  if (type === "img-quiz") {
	    imgQuizCount++;
	  }
	});
	if (imgQuizCount > 3) {
	  alert("ì´ë¯¸ì§€ í€´ì¦ˆëŠ” 3ê°œê¹Œì§€ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
	  return;
	}
    
	// ë¬¸ì œ ì œëª© null ë°©ì§€
	const title = $("#quizTitle").val().trim();
	if (title === "") {
	  alert("í€´ì¦ˆ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
	  $("#quizTitle").focus();
	  return;
	}
	
	//í•„ìˆ˜ ì…ë ¥ê°’ ê²€ì¦
	let isValid = true;

	$(".slide").each(function (i) {
	  const question = $(this).find(".quiz-question").val().trim();
	  if (question === "") {
	    alert(`${i + 1}ë²ˆ ë¬¸ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
	    $(this).find(".quiz-question").focus();
	    isValid = false;
	    return false;
	  }
	
	  const options = $(this).find(".option-content");
	  for (let j = 0; j < options.length; j++) {
	    if ($(options[j]).val().trim() === "") {
	      alert(`${i + 1}ë²ˆ ë¬¸ì œì˜ ë³´ê¸° ${j + 1}ë²ˆ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
	      $(options[j]).focus();
	      isValid = false;
	      return false;
	    }
	  }
	
	  const correct = $(this).find(".correct-option").val();
	  if (!correct) {
	    alert(`${i + 1}ë²ˆ ë¬¸ì œì˜ ì •ë‹µì„ ì„ íƒí•´ì£¼ì„¸ìš”.`);
	    $(this).find(".correct-option").focus();
	    isValid = false;
	    return false;
	  }
	});
	
	if (!isValid) return;

	
	
    $(".slide").each(function (quizIdx) {
      const quiz = existingQuizList[quizIdx];
      const type = $(this).find(".quiz-type").val();
      const question = $(this).find(".quiz-question").val();
      const correctOption = $(this).find(".correct-option").val();
      const options = [];

      $(this).find(".option-row").each(function () {
        const content = $(this).find(".option-content").val();
        const fileInput = $(this).find(".option-image");
        const imageName = $(this).find(".option-image-name").val();
        const imageAddr = $(this).find(".option-image-addr").val();
        let fileIndex = null;

        if (fileInput && fileInput.length && fileInput[0].files.length > 0) {
          fileIndex = imageFiles.length;
          imageFiles.push(fileInput[0].files[0]);
        }

        options.push({ content, fileIndex, imageName, imageAddr });
      });

      quizList.push({
        quizSeq: quiz.quizSeq,
        type,
        question,
        correctOption: parseInt(correctOption),
        options
      });
    });

    const formData = new FormData();
    formData.append("quizListSeq", $("#quizListSeq").val());
    formData.append("quizJson", JSON.stringify({
      title: $("#quizTitle").val(),
      langCategory: $("#langCategory").val(),
      quiz: quizList
      
    }));
    imageFiles.forEach(file => formData.append("imageFiles", file));

    axios.post("/modifyQuizForm", formData, {
      headers: { "Content-Type": "multipart/form-data" }
    })
    .then(res => {
      if (res.data === "success") {
        alert("ìˆ˜ì • ë˜ì—ˆìŠµë‹ˆë‹¤.");
        location.reload();
        //const courseSeq = document.getElementById("quizCourseSeq").value;
        //window.location.href = '/upload/upload_course?seq='+courseSeq;
      } else if (res.data === "unauthorized") {
    	    alert("ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    	    window.location.href = '/';
      }
    })
    .catch(err => {
      console.error("ìˆ˜ì • ì‹¤íŒ¨", err);
      alert("ìˆ˜ì •ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
    });
  });

  // ì‚­ì œ ë²„íŠ¼
  $("#deleteQuizBtn").click(function () {
    const quizListSeq = $("#quizListSeq").val();
    const courseSeq = $("#quizCourseSeq").val();
    
    if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    axios.post("/deleteQuizList/" + quizListSeq)
      .then(res => {
        if (res.data === "delete") {
          alert("ì‚­ì œ ë˜ì—ˆìŠµë‹ˆë‹¤.");
          window.location.href = '/upload/upload_course?seq='+courseSeq;
        } else if (res.data === "accessfailed") {
            alert("ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
            window.location.href = '/';  
          }
      })
      .catch(err => {
        console.error("ì‚­ì œ ì‹¤íŒ¨", err);
        alert("ì‚­ì œê°€ ì‹¤íŒ¨ë˜ì—ˆìŠµë‹ˆë‹¤.");
      });
  });

  
  // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  $("#backButton").click(function() {
	  const courseSeq = $("#quizCourseSeq").val();
	  window.location.href = '/upload/upload_course?seq=' + courseSeq;
  });
  
  // ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ â†’ í•™ìŠµ í™”ë©´ìœ¼ë¡œ ì´ë™
  $("#playButton").click(function () {
    const quizListSeq = $("#quizListSeq").val();
    const courseSeq = $("#quizCourseSeq").val();
    window.location.href = `/quiz/playQuiz/${quizListSeq}?courseSeq=${courseSeq}&from=modify`;
  });
  
});
</script>

</body>
</html>
