<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>LangTrip | í€´ì¦ˆ í•™ìŠµ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link rel="stylesheet" th:href="@{/css/playQuiz.css}">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
<form id="quizPlay">
  <input type="hidden" id="quizListSeq" th:value="${quizListSeq}" />
  <input type="hidden" id="courseSeq" th:value="${courseSeq}" />
  <input type="hidden" id="from" th:value="${from}" />


  <!-- ìƒë‹¨ ì§„í–‰ë¥  ë°” -->
  <div class="d-flex justify-content-between align-items-center p-2">
    <button type="button" class="btn exit-quiz-btn" id="exitQuizBtn">X</button>
    <div class="w-100 px-3">
      <div class="progress">
        <div class="progress-bar bg-info" id="progressFill" style="width: 0%"></div>
      </div>
    </div>
    <div id="progressText" class="me-3">0/5</div>
  </div>

<!-- í€´ì¦ˆ ì •ë³´ ì˜ì—­ -->
<div class="container my-4 d-flex justify-content-between align-items-center" id="quizInfoBox">
  <div>
    <span id="quizStatusDisplay" class="badge bg-secondary"></span>
    <h4 id="quizTitleDisplay" class="fw-bold mb-1"></h4>
  </div>
</div>

  <!-- í€´ì¦ˆ ìŠ¬ë¼ì´ë“œê°€ ì‚½ì…ë  ì˜ì—­ -->
  <div id="quizContainer"></div>

  <!-- í•˜ë‹¨ ì œì¶œ ë²„íŠ¼ ë„¤ë¹„ê²Œì´ì…˜ -->
  <div class="bottom-navbar">
    <div id="feedbackMessageContainer"></div> <!-- í”¼ë“œë°± ë©”ì‹œì§€ í‘œì‹œìš© -->
    <button id="submitBtn" type="button" class="btn btn-info">ì œì¶œí•˜ê¸°</button>
  </div>
</form>

  <!-- í€´ì¦ˆ ì¢…ë£Œ ëª¨ë‹¬ì°½ -->
  <div id="exitQuizCustomModal" class="custom-modal-overlay">
    <div class="custom-modal-content">
      <div class="modal-header-close">
        <span class="close-button">&times;</span>
      </div>
      <div class="modal-body-content">
        <img src="/images/quiz/mascot_sad.png" alt="Mascot" class="modal-mascot-img">
        <p class="modal-message">ì •ë§ í€´ì¦ˆë¥¼ ì¢…ë£Œí•˜ì‹œê² ì–´ìš”?</p>
        <p class="modal-sub-message">ì§„í–‰ ìƒí™©ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
      </div>
      <div class="modal-footer-buttons">
        <button type="button" id="cancelExitQuiz" class="modal-button cancel-button">ê³„ì† í’€ê¸°</button>
        <button type="button" id="confirmExitQuiz" class="modal-button exit-button">ì¢…ë£Œí•˜ê¸°</button>
      </div>
    </div>
  </div>

  <script>
  const selections = {}; // ì‚¬ìš©ì ì‘ë‹µ ì €ì¥
  let currentIndex = 0;  // í˜„ì¬ í€´ì¦ˆ ì¸ë±ìŠ¤
  let slides = [];       // ëª¨ë“  í€´ì¦ˆ ìŠ¬ë¼ì´ë“œ ì €ì¥
  let feedbackDisplayed = false; // í”¼ë“œë°± í‘œì‹œ ì—¬ë¶€ í”Œë˜ê·¸

  // ìŠ¬ë¼ì´ë“œë¥¼ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜
  function showSlide(index) {
	  
    slides.forEach((slide, i) => {
    slide.style.display = i === index ? 'block' : 'none';
	});//forEach
    
    // ìŠ¬ë¼ì´ë“œ ë³€ê²½ ì‹œ í”¼ë“œë°± ê´€ë ¨ ìƒíƒœ ì´ˆê¸°í™”
    document.getElementById("submitBtn").textContent = "ì œì¶œí•˜ê¸°";
    document.getElementById("bottomNavbar").classList.remove("correct-feedback", "incorrect-feedback");
    feedbackDisplayed = false;

    const currentSlide = slides[currentIndex];
    const feedbackMessageContainer = document.getElementById("feedbackMessageContainer");
   
    if (feedbackMessageContainer) {
        feedbackMessageContainer.innerHTML = ""; // ì´ì „ í”¼ë“œë°± ë©”ì‹œì§€ ì œê±°
    }
     currentSlide.querySelectorAll(".option-btn, .card-option").forEach(el => {
     el.classList.remove("selected-correct", "selected-incorrect", "correct-highlight");
     el.style.pointerEvents = "auto"; // ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ
    });//forEach
    
  }//showSlide

  // ì§„í–‰ë¥  ë°” ì—…ë°ì´íŠ¸ (ì‘ë‹µ ìˆ˜ ê¸°ì¤€)
  function updateProgress() {
    const answered = Object.keys(selections).length;
    const percent = (answered / slides.length) * 100;
    document.getElementById("progressFill").style.width = percent + "%";
    document.getElementById("progressText").textContent = `${answered}/${slides.length}`;
  }

  // ë³´ê¸° í´ë¦­ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ > ì„ íƒë§Œ ì €ì¥, ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ëŠ” í•˜ì§€ ì•ŠìŒ
  function selectAnswer(quizSeq, answer, el) {
    if (feedbackDisplayed) return; // í”¼ë“œë°±ì´ í‘œì‹œëœ ìƒíƒœì—ì„œëŠ” ì„ íƒ ë³€ê²½ ë¶ˆê°€

    document.querySelectorAll(`[data-quiz='${quizSeq}']`).forEach(el => el.classList.remove("selected"));
    el.classList.add("selected");
    selections[quizSeq] = answer;
  }

  // ë‹¨ì¼ í€´ì¦ˆ : ë³´ê¸° ì œì¶œì‹œ í”¼ë“œë°± ì²˜ë¦¬
  async function processAnswerFeedback() {
    const currentSlide = slides[currentIndex];
    //í˜„ì¬ ìŠ¬ë¼ì´ë“œì—ì„œ quizSeq ê°€ì ¸ì˜¤ê¸°
    const quizSeq = currentSlide.querySelector(".option-btn, .card-option")?.dataset.quiz;
   	//í•´ë‹¹ í€´ì¦ˆì— ëŒ€í•œ ì‚¬ìš©ìì˜ ì„ íƒëœ ë³´ê¸° ë²ˆí˜¸ selectOption ê°€ì ¸ì˜´
    const selectOption = selections[quizSeq];

    if (!selectOption) {
      alert("ë³´ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }

    const quizListSeq = document.getElementById("quizListSeq").value;
    const courseSeq = document.getElementById("courseSeq").value;
    //DOM ê°ì²´ ìºì‹±
    const bottomNavbar = document.getElementById("bottomNavbar");
    const submitBtn = document.getElementById("submitBtn");

    try {
       const response = await axios.post("/submitAnswer", { 
	        quizSeq: quizSeq,
	        quizListSeq: quizListSeq,
	        courseSeq: courseSeq,
	        selectOption: selectOption,
      });
	 //ì„œë²„ ì‘ë‹µ ê²°ê³¼ë¡œ í”¼ë“œë°± ì²˜ë¦¬
      const { correct, correctOption, correctContent } = response.data;
      
      console.log('correctOption:', correctOption, 'correctContent:', correctContent);

      // í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” ìƒ‰ìƒ ë³€ê²½
      if (correct) {
        bottomNavbar.classList.add("correct-feedback");
      } else {
        bottomNavbar.classList.add("incorrect-feedback");
      }

      // ì œì¶œí•˜ê¸° ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
      submitBtn.textContent = "ê³„ì†í•˜ê¸°";

      // í”¼ë“œë°± ë©”ì‹œì§€ í‘œì‹œ
      const feedbackMessageDiv = document.createElement("div");
      feedbackMessageDiv.className = "feedback-message";
      feedbackMessageDiv.style.fontWeight = "bold";

      if (correct) {
        feedbackMessageDiv.textContent = "ì •ë‹µì…ë‹ˆë‹¤!";
        feedbackMessageDiv.classList.add("correct-feedback-message");
      } else {
        feedbackMessageDiv.textContent = `ì˜¤ë‹µì…ë‹ˆë‹¤! ì •ë‹µ: ${correctContent}`;
        feedbackMessageDiv.classList.add("incorrect-feedback-message");
      }
      const feedbackMessageContainer = document.getElementById("feedbackMessageContainer");
      feedbackMessageContainer.appendChild(feedbackMessageDiv);


      // ì„ íƒëœ ë³´ê¸° ë° ì •ë‹µ ë³´ê¸° ìŠ¤íƒ€ì¼ ì ìš© ë° ì„ íƒ ë¶ˆê°€ ì²˜ë¦¬
      currentSlide.querySelectorAll(`[data-quiz='${quizSeq}']`).forEach(el => {
        
    	el.style.pointerEvents = "none"; // ì„ íƒ ë³€ê²½ ë¶ˆê°€
        const optionNumber = parseInt(el.dataset.answer);

        if (optionNumber === selectOption) {
          el.classList.add(correct ? "selected-correct" : "selected-incorrect");
        }
       /*  if (optionNumber === correctOption) {
          el.classList.add("correct-highlight");
        } */
        
      });//forEach 
	      feedbackDisplayed = true; //í”¼ë“œë°± í‘œì‹œ
	      updateProgress(); // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
   
    } catch (err) {
    	console.error(`${quizSeq} ì‘ë‹µ ì²˜ë¦¬ ì‹¤íŒ¨`, err);
     	alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }//processAnswerFeedback

  // ì„œë²„ë¡œ ëª¨ë“  ê²°ê³¼ ì „ì†¡
  function submitAllQuizResponses() {
	  
    const quizListSeq = document.getElementById("quizListSeq").value;
    const courseSeq = document.getElementById("courseSeq").value;
    const from = document.getElementById("from")?.value || "course";
    
    //selections:ì‘ë‹µì´ ì €ì¥ë˜ì–´ìˆëŠ” ê°ì²´
    //map:QuizResponseDTO í˜•ì‹ì˜ ë°°ì—´ë¡œ ë³€í™˜
	const responses = Object.entries(selections).map(([quizSeq, selectOption]) => ({
		quizListSeq,
		quizSeq,
		courseSeq,
		selectOption
	}));//responses
	
	// ì‘ë‹µ insert
	axios.post("/quizResponse", responses)
	.then(res => {
		 //window.location.href = `/quiz/quizCompleted/${quizListSeq}?courseSeq=${courseSeq}&from=${from}`;
		 const from = document.getElementById("from")?.value || "course";  
		    let url = `/quiz/quizCompleted/${quizListSeq}?courseSeq=${courseSeq}`;
		    if (from === 'modify') {
		        url += '&from=modify';
		    }
		    window.location.href = url;
	})
	.catch(err => {
	    console.error("ì‘ë‹µ ì €ì¥ ì‹¤íŒ¨", err);
	    alert("ì œì¶œí•˜ëŠ” ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
	})
    
  }//submitAllQuizResponses
  
  // ì œì¶œ ë²„íŠ¼ í´ë¦­ ì‹œ ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™í•˜ê±°ë‚˜ ìµœì¢… ì œì¶œ
  function handleSubmit() {
    if (!feedbackDisplayed) {
      processAnswerFeedback(); // ë‹¨ì¼ í€´ì¦ˆ : ë³´ê¸° ì œì¶œì‹œ í”¼ë“œë°± ì²˜ë¦¬
    } else {
      // í”¼ë“œë°±ì´ í‘œì‹œëœ ìƒíƒœì—ì„œ ë²„íŠ¼ í´ë¦­ ì‹œ
      if (currentIndex < slides.length - 1) {
        currentIndex++;
        showSlide(currentIndex); //ë‹¤ìŒ ë¬¸ì œ ìŠ¬ë¼ì´ë“œë¡œ ì´ë™
      } else {
        submitAllQuizResponses(); // ëª¨ë“  í€´ì¦ˆ ì‘ë‹µ ìµœì¢… ì œì¶œ
      }
    }
  }//handleSubmit

  // í˜ì´ì§€ ë¡œë“œ ì‹œ í€´ì¦ˆ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  document.addEventListener("DOMContentLoaded", () => {
	console.log("âœ… DOMContentLoaded ì‹¤í–‰ë¨");
    const quizListSeq = document.getElementById("quizListSeq").value;
    console.log("ğŸ“Œ quizListSeq:", quizListSeq);
    
    axios.get(`/playQuizProcess/${quizListSeq}`)
      .then(res => {
        const quizList = res.data.quizList;
        const title = res.data.quizTitle;
        const status = res.data.status;
        console.log("ğŸ¯ quizList ë‚´ìš©:", quizList);
        
        if (!Array.isArray(quizList) || quizList.length === 0) {
            alert("í€´ì¦ˆê°€ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            console.error("ì„œë²„ ì‘ë‹µ:", res.data);
            return;
          }
        
        // ì œëª© ì¶œë ¥
        document.getElementById("quizTitleDisplay").textContent = title;

        // ìƒíƒœ ì¶œë ¥
        const statusEl = document.getElementById("quizStatusDisplay");
        if (status === "complete") {
          statusEl.textContent = "í•™ìŠµ ì™„ë£Œ";
          statusEl.className = "badge bg-success";
        } else {
          statusEl.textContent = "í•™ìŠµ ì „";
          statusEl.className = "badge bg-secondary";
        }
        
        const container = document.getElementById("quizContainer");

        quizList.forEach((quiz, index) => {
          console.log(`Processing quiz ${index + 1}:`, quiz); 
          const slide = document.createElement("div");
          slide.className = "quiz-slide";
          slide.style.display = index === 0 ? "block" : "none";

          let optionsHTML = "";
          if (quiz.type === 'text-quiz') {
            optionsHTML = quiz.options.map((opt, i) => `
              <button type="button" class="btn btn-outline-secondary option-btn"
                data-quiz="${quiz.quizSeq}" data-answer="${i + 1}">
                ${i + 1}. ${opt.content}
              </button>`).join("<br/>");
          } else {
              optionsHTML = '<div class="row row-cols-3 g-3">' + quiz.options.map((opt, i) => `
              <div class="col">
                <div class="card card-option text-center" data-quiz="${quiz.quizSeq}" data-answer="${i + 1}">
                  <img src="/quiz/${opt.imageName}" class="card-img-top" alt="option">
                  <div class="card-body">
                    <p class="card-text">${i + 1}. ${opt.content}</p>
                  </div>
                </div>
              </div>`).join("") + '</div>';
          }

          // í€´ì¦ˆ ìŠ¬ë¼ì´ë“œ êµ¬ì„±
          slide.innerHTML = `
            <div class="container my-4">
              <div class="d-flex align-items-start mascot-speech-container">
                <img src="/images/quiz/mascot.png" class="mascot me-3">
                <div class="speech-bubble">ë¬¸ì œ ${index + 1}: ${quiz.question}</div>
              </div>
              <div class="options-container">${optionsHTML}</div>
            </div>
          `;
          console.log(`Final slide.innerHTML for quiz ${index + 1}:`, slide.innerHTML); 

          // ë³´ê¸° í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
          slide.addEventListener("click", e => {
            const target = e.target.closest(".option-btn, .card-option");
            if (!target) return;
            const quizSeq = target.dataset.quiz;
            const answer = target.dataset.answer;
            selectAnswer(quizSeq, answer, target);
          });

          slides.push(slide);
          container.appendChild(slide);
        });
        showSlide(currentIndex); // ì²« ë²ˆì§¸ ìŠ¬ë¼ì´ë“œ í‘œì‹œ
      })
      .catch(err => console.error("í€´ì¦ˆ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", err));

    // í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°”ì— ID ì¶”ê°€
    document.querySelector(".bottom-navbar").id = "bottomNavbar";
   
    // ì œì¶œ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
    document.getElementById("submitBtn").addEventListener("click", handleSubmit);

    // X ë²„íŠ¼ í´ë¦­ ì‹œ ì»¤ìŠ¤í…€ ëª¨ë‹¬ í‘œì‹œ
    document.getElementById("exitQuizBtn").addEventListener("click", () => {
    document.getElementById("exitQuizCustomModal").style.display = "flex";
    });

    // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ (X) í´ë¦­ ì‹œ
    document.querySelector("#exitQuizCustomModal .close-button").addEventListener("click", () => {
      document.getElementById("exitQuizCustomModal").style.display = "none";
    });

    // ëª¨ë‹¬ 'ê³„ì† í’€ê¸°' ë²„íŠ¼ í´ë¦­ ì‹œ
    document.getElementById("cancelExitQuiz").addEventListener("click", () => {
      document.getElementById("exitQuizCustomModal").style.display = "none";
    });

    // ëª¨ë‹¬ 'ì¢…ë£Œí•˜ê¸°' ë²„íŠ¼ í´ë¦­ ì‹œ
    document.getElementById("confirmExitQuiz").addEventListener("click", () => {
      window.history.back();
      
    });
  });
</script>
  </body>
</html>
